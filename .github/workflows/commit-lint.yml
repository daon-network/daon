name: Lint Commit Messages

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  commitlint:
    name: Lint Commit Messages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install commitlint
        run: |
          npm install -g @commitlint/cli @commitlint/config-conventional

      - name: Validate commit messages
        run: |
          echo "ğŸ” Checking commit messages in this PR..."
          
          # Get commit messages from this PR
          git log --format="%H %s" origin/main..HEAD > commits.txt
          
          # Check each commit message
          failed=0
          while IFS= read -r line; do
            if [ -n "$line" ]; then
              hash=$(echo "$line" | cut -d' ' -f1)
              message=$(echo "$line" | cut -d' ' -f2-)
              echo "ğŸ“ Checking: $message"
              
              if echo "$message" | npx commitlint; then
                echo "âœ… Valid: $message"
              else
                echo "âŒ Invalid: $message"
                failed=1
              fi
            fi
          done < commits.txt
          
          if [ $failed -eq 1 ]; then
            echo ""
            echo "âŒ Some commit messages don't follow conventional format!"
            echo ""
            echo "ğŸ“‹ Valid formats:"
            echo "  feat: add new feature"
            echo "  fix: resolve bug"  
            echo "  docs: update documentation"
            echo "  chore: maintenance tasks"
            echo ""
            echo "Please squash/rewrite commits with proper conventional format."
            exit 1
          fi
          
          echo ""
          echo "âœ… All commit messages are properly formatted!"

      - name: Check for merge commits
        run: |
          # Prevent merge commits in PRs (excluding GitHub's temporary PR merge commits)
          merge_count=$(git log --merges --format="%s" origin/main..HEAD | grep -v "^Merge [0-9a-f]\+ into [0-9a-f]\+$" | wc -l)
          if [ "$merge_count" -gt 0 ]; then
            echo "âŒ Merge commits detected in PR!"
            echo "Please rebase instead of merging."
            git log --merges --format="%H %s" origin/main..HEAD | grep -v "^[0-9a-f]\+ Merge [0-9a-f]\+ into [0-9a-f]\+$"
            exit 1
          fi
          echo "âœ… No merge commits found"